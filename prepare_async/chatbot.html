<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï±óÎ¥á-ÎπÑÎèôÍ∏∞ -> Î™®Îì† ÏßàÎ¨∏ÏùÑ Î£®Î®∏ÏóêÏù¥Ï†ÑÌä∏Î°úÎßå Î≥¥ÎÇ¥ÏÑú Ï≤òÎ¶¨Îê®</title>
    <script type="module">
        import { Client } from "https://esm.sh/@langchain/langgraph-sdk";
        import { marked } from "https://esm.sh/marked@12.0.0";
        window.LangGraphClient = Client;

        // marked ÏÑ§Ï†ï: Îã®Ïùº Ï§ÑÎ∞îÍøàÎèÑ <br>Î°ú Î≥ÄÌôò
        const renderer = new marked.Renderer();
        renderer.link = function(href, title, text) {
            return `<a href="${href}" target="_blank" rel="noopener noreferrer"${title ? ` title="${title}"` : ''}>${text}</a>`;
        };

        marked.setOptions({
            breaks: true,  // Îã®Ïùº Ï§ÑÎ∞îÍøàÏùÑ <br>Î°ú Î≥ÄÌôò
            gfm: true,     // GitHub Flavored Markdown ÏÇ¨Ïö©
            renderer: renderer
        });

        window.marked = marked;

        // ÌÅ¥ÎûòÏä§ Ï†ïÏùò ÎåÄÍ∏∞
        window.addEventListener('load', () => {
            if (window.AsyncChatBot) {
                window.chatBot = new window.AsyncChatBot();
            }
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-messages {
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: 20%;
        }
        .bot-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        #userInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        #sendButton {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #sendButton:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 14px;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            display: block;
        }
        .toggle-btn:hover {
            background: #0056b3;
        }
        .toggle-btn.secondary {
            background: #6c757d;
            color: white;
        }
        .toggle-btn.secondary:hover {
            background: #545b62;
        }
        .toggle-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>Ï±óÎ¥á-ÎπÑÎèôÍ∏∞ -> Î™®Îì† ÏßàÎ¨∏ÏùÑ Î£®Î®∏ÏóêÏù¥Ï†ÑÌä∏Î°úÎßå Î≥¥ÎÇ¥ÏÑú Ï≤òÎ¶¨Îê®</h1>
        <div id="status" class="status"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="input-container">
            <input type="text" id="userInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." />
            <button id="sendButton">Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        class AsyncChatBot {
            constructor() {
                this.proxyUrl = 'http://localhost:8080'; // Python ÌîÑÎ°ùÏãú ÏÑúÎ≤Ñ
                this.currentRunId = null;
                this.currentThreadId = null;
                this.eventSource = null;
                this.isProcessing = false;
                this.keyCounter = {}; // ÌÇ§Î≥Ñ Ï∂úÌòÑ ÌöüÏàò Ï∂îÏ†Å
                this.langGraphClient = new window.LangGraphClient({
                    apiUrl: "http://211.188.53.220:2025"
                });

                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.chatMessages = document.getElementById('chatMessages');
                this.userInput = document.getElementById('userInput');
                this.sendButton = document.getElementById('sendButton');
                this.status = document.getElementById('status');
            }

            bindEvents() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }

            updateStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            addMessage(content, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
                messageDiv.textContent = content;
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addBotMessage(content, isPartial = false, isMarkdown = false) {
                let lastBotMessage = this.chatMessages.querySelector('.bot-message:last-child');

                if (isPartial && lastBotMessage && lastBotMessage.dataset.partial === 'true') {
                    if (isMarkdown) {
                        lastBotMessage.innerHTML += window.marked.parse(content);
                    } else {
                        lastBotMessage.textContent += content;
                    }
                } else {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message bot-message';

                    if (isMarkdown) {
                        messageDiv.innerHTML = window.marked.parse(content);
                    } else {
                        messageDiv.textContent = content;
                    }

                    messageDiv.dataset.partial = isPartial ? 'true' : 'false';
                    this.chatMessages.appendChild(messageDiv);
                }

                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }


            addToggleMessage(title, content, isMarkdown = false, isFirst = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';

                const toggleBtn = document.createElement('button');
                toggleBtn.className = isFirst ? 'toggle-btn' : 'toggle-btn secondary';
                toggleBtn.textContent = `‚ñ∂ ${title}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'toggle-content';

                if (isMarkdown) {
                    contentDiv.innerHTML = window.marked.parse(content);
                } else {
                    // JSONÏù¥ÎÇò ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î•º Î≥¥Í∏∞ Ï¢ãÍ≤å ÌëúÏãú
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.style.fontFamily = 'monospace';
                    contentDiv.style.fontSize = '14px';
                    contentDiv.textContent = content;
                }

                toggleBtn.addEventListener('click', () => {
                    if (contentDiv.style.display === 'none' || contentDiv.style.display === '') {
                        contentDiv.style.display = 'block';
                        toggleBtn.textContent = `‚ñº ${title}`;
                    } else {
                        contentDiv.style.display = 'none';
                        toggleBtn.textContent = `‚ñ∂ ${title}`;
                    }
                });

                messageDiv.appendChild(toggleBtn);
                messageDiv.appendChild(contentDiv);
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            async sendMessage() {
                const query = this.userInput.value.trim();
                if (!query || this.isProcessing) return;

                this.isProcessing = true;
                this.sendButton.disabled = true;
                this.userInput.disabled = true;

                // ÏÉà Î©îÏãúÏßÄ ÏãúÏûë Ïãú ÌÇ§ Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
                this.keyCounter = {};

                this.addMessage(query, true);
                this.userInput.value = '';

                try {
                    await this.startRumAgentRun(query);
                } catch (error) {
                    console.error('Error:', error);
                    this.addMessage('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, false);
                    this.updateStatus('Ïò§Î•ò Î∞úÏÉù', 'error');
                } finally {
                    this.isProcessing = false;
                    this.sendButton.disabled = false;
                    this.userInput.disabled = false;
                    this.userInput.focus();
                }
            }

            async startRumAgentRun(query) {
                this.updateStatus('ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë...', 'connecting');

                // JavaScriptÏóêÏÑú Î™®Îì† Î°úÏßÅ Ï≤òÎ¶¨
                const requestData = {
                    assistant_id: "rum_multi_agent",
                    input: { query: query },
                    if_not_exists: "create",
                    stream_mode: 'values'
                };

                // Í∞ÑÎã®Ìïú ÌîÑÎ°ùÏãúÎ•º ÌÜµÌï¥ ÏöîÏ≤≠
                const response = await fetch(`${this.proxyUrl}/runs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const runData = await response.json();
                console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', runData);

                this.currentRunId = runData.run_id;
                this.currentThreadId = runData.thread_id;

                if (!this.currentRunId || !this.currentThreadId) {
                    console.error('run_id ÎòêÎäî thread_idÍ∞Ä ÏóÜÏäµÎãàÎã§:', runData);
                    throw new Error('run_id ÎòêÎäî thread_idÎ•º Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§');
                }

                console.log(`Run ID: ${this.currentRunId}, Thread ID: ${this.currentThreadId}`);

                // Ï¶âÏãú Ïä§Ìä∏Î¶º ÏãúÏûë
                await this.startEventStream();
            }

            async startEventStream() {
                this.updateStatus('Ïã§ÏãúÍ∞Ñ ÏùëÎãµ ÏàòÏã† Ï§ë...', 'connected');

                try {
                    console.log('‚úÖ SDKÎ°ú Ïä§Ìä∏Î¶º ÏãúÏûë');
                    this.updateStatus('Ïä§Ìä∏Î¶º Ïó∞Í≤∞Îê®', 'connected');

                    // LangGraph SDKÎ°ú join_stream
                    const streamResponse = this.langGraphClient.runs.joinStream(
                        this.currentThreadId,
                        this.currentRunId
                    );

                    for await (const chunk of streamResponse) {
                        console.log('SDK Ï≤≠ÌÅ¨ ÏàòÏã†:', chunk);
                        this.handleStreamEvent(chunk);
                    }

                    console.log('‚úÖ Ïä§Ìä∏Î¶º ÏôÑÎ£å');
                    this.updateStatus('ÏùëÎãµ ÏôÑÎ£å', 'connected');

                } catch (error) {
                    console.error('‚ùå Ïä§Ìä∏Î¶º Ïò§Î•ò:', error);
                    this.updateStatus('Ïä§Ìä∏Î¶º Ïó∞Í≤∞ Ïò§Î•ò', 'error');
                }
            }

            parseSSEEvent(eventText) {
                const now = new Date().toLocaleTimeString();
                console.log(`üïí [${now}] SSE Ïù¥Î≤§Ìä∏:`, eventText);

                const lines = eventText.split('\n');
                let eventType = '';
                let data = '';
                let id = '';

                for (const line of lines) {
                    if (line.startsWith('event: ')) {
                        eventType = line.slice(7);
                    } else if (line.startsWith('data: ')) {
                        data = line.slice(6);
                    } else if (line.startsWith('id: ')) {
                        id = line.slice(4);
                    }
                }

                if (data === '[DONE]') {
                    console.log('‚úÖ Ïä§Ìä∏Î¶º ÏôÑÎ£å');
                    this.updateStatus('ÏùëÎãµ ÏôÑÎ£å', 'connected');
                    return;
                }

                if (data) {
                    console.log(`üìä Îç∞Ïù¥ÌÑ∞ Í∏∏Ïù¥: ${data.length}Ïûê`);
                    try {
                        const eventData = JSON.parse(data);
                        console.log(`üîÑ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ Ï§ë... (ÌÉÄÏûÖ: ${eventType})`);
                        this.handleStreamEvent(eventData);
                    } catch (error) {
                        console.error('JSON ÌååÏã± Ïò§Î•ò:', error);
                        console.log('ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞:', data.substring(0, 200) + '...');
                    }
                }
            }


            handleStreamEvent(eventData) {
                const eventType = eventData.event || '';

                console.log(`Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖ: ${eventType}`);

                // dataÍ∞Ä ÏûàÏúºÎ©¥ ÌôîÎ©¥Ïóê ÌëúÏãú (500Ïûê Ï†úÌïú) - Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ
                if (eventData.data) {
                    let dataString = JSON.stringify(eventData.data, null, 2);
                    if (dataString.length > 500) {
                        // 500ÏûêÍ∞Ä ÎÑòÏúºÎ©¥ ÌÇ§Í∞íÎì§Í≥º Ï≤òÏùå 500ÏûêÎßå ÌëúÏãú
                        const keys = Object.keys(eventData.data).join(', ');
                        dataString = `Keys: [${keys}]\n${dataString.substring(0, 500)}...`;
                    }
                    this.addBotMessage(`üìã ${eventType} | ${dataString}`);

                    // Ï∂îÍ∞Ä: ÌäπÏ†ï ÌÇ§Îì§ÏùÑ ÌÜ†Í∏ÄÎ°ú markdown ÌëúÏãú (ÏúÑ ÏöîÏïΩÎ≥∏Í≥º Í∞ôÏùÄ Ïù¥Î≤§Ìä∏)
                    const markdownKeys = ['generated_response', 'news_results', 'search_summary', 'selected_documents'];
                    for (const key of markdownKeys) {
                        if (eventData.data[key]) {
                            // ÌÇ§Î≥Ñ Ï∂úÌòÑ ÌöüÏàò Ï∂îÏ†Å
                            this.keyCounter[key] = (this.keyCounter[key] || 0) + 1;
                            const count = this.keyCounter[key];
                            const countText = count > 1 ? ` (${count}Î≤àÏß∏)` : '';
                            const isFirst = count === 1;

                            let content;
                            let isMarkdown = false;

                            if (typeof eventData.data[key] === 'string') {
                                content = eventData.data[key];
                                // ÌÖçÏä§Ìä∏ ÌÇ§Îì§ÏùÄ markdownÏúºÎ°ú Î†åÎçîÎßÅ
                                if (key === 'search_summary' || key === 'generated_response') {
                                    isMarkdown = true;
                                }
                            } else {
                                content = JSON.stringify(eventData.data[key], null, 2);
                            }
                            this.addToggleMessage(`‚Ü™Ô∏è ${key}${countText} (Full)`, content, isMarkdown, isFirst);
                        }
                    }
                }

                if (eventData.generated_response) {
                    let response = eventData.generated_response;
                    if (response.length > 500) {
                        response = response.substring(0, 500) + '...';
                    }
                    this.addBotMessage(response);

                    // Ï∂îÍ∞Ä: generated_response Ï†ÑÏ≤¥Î•º markdownÏúºÎ°ú ÌëúÏãú
                    this.addBotMessage(`### Generated Response (Full)\n${eventData.generated_response}`, false, true);
                }

                if (eventType.includes('message') || eventType.includes('response')) {
                    if (eventData.content) {
                        let content = eventData.content;
                        if (content.length > 500) {
                            content = content.substring(0, 500) + '...';
                        }
                        this.addBotMessage(content);
                    }
                    if (eventData.text) {
                        let text = eventData.text;
                        if (text.length > 500) {
                            text = text.substring(0, 500) + '...';
                        }
                        this.addBotMessage(text);
                    }
                }

                if (eventType === 'thread.run.completed') {
                    this.updateStatus('ÏùëÎãµ ÏôÑÎ£å', 'connected');
                }
            }
        }

        window.AsyncChatBot = AsyncChatBot;
    </script>
</body>
</html>