CLOVASTUDIO_API_KEY="nv-a49..."


from langchain_core.prompts import PromptTemplate
from langchain_naver import ChatClovaX
# 질문 유형 판단용 프롬프트

# 질문 유형 판단용 프롬프트 (출력 형식 지정)
question_classifier_template = PromptTemplate(
    input_variables=["query"],
    template="""
당신은 한국 주식 전문가입니다. 
사용자가 입력한 질문을 아래 4가지 유형 중 정확히 하나로 분류하세요. 
반드시 JSON 형식으로만 출력해야 합니다.

1. 공시: 기업 공시, 실적, 임상시험, 배당, M&A 등 공식 공시 기반 정보
   - 예시: "하닉스 실적 언제 발표돼?", "카뱅 IPO 관련 공시 확인해줘"

2. 루머체크: 특정 기업 관련 소문, 루머, 뉴스 진위 여부 확인
   - 예시: "LG화학 배터리 관련 루머 진짜야?", "현대차 중국 진출설 확인해줘"

3. 주가검색: 시스템에서 실제로 지원되는 종목/시장 데이터 조회만 가능
   - 가능한 내용:
     - 특정 종목 시가/고가/저가/종가/거래량/등락률 조회
     - 시장 지수 조회 (KOSPI/KOSDAQ)
     - 시장 통계 조회
     - 가격/거래량/등락률 순위 조회
     - 기술적 지표 신호 조회 (RSI, 볼린저밴드, 이동평균선, 골든/데드크로스 등)
     - 복합조건 검색
   - 예시: "삼성전자 오늘 종가 얼마야?", "KOSPI 지수 오늘 얼마야?", "RSI 과매수 종목 알려줘"
   - ⚠️ PER, PBR, EPS 조회 및 투자 판단/추천/해석 관련 질문은 포함되지 않음

4. 기타: 투자 판단, 매수/매도 타이밍, 홀딩 여부, 물타기, 전략 관련 질문
   - 예시: "삼성전자 물타기 타이밍이야?", "카카오 하락장에서 홀딩해도 될까?"

질문: {query}

반드시 아래 형식으로 출력:
{{"type": "<공시/루머체크/주가검색/기타>"}}

- < > 안에는 하나의 유형만 들어가야 합니다.
- 절대 다른 형식이나 추가 텍스트를 넣지 마세요.
- 모호한 경우에도 반드시 위 네 가지 중 하나만 선택하세요.
- JSON 외 다른 텍스트를 출력하지 마세요.
"""
)



llm = ChatClovaX(
    model = "HCX-007",
    thinking= {
        "effort":"none"
    },
    api_key = CLOVASTUDIO_API_KEY,
)
test_set = [
"삼성전자 최근 공시 알려줘",
"SK하이닉스 오늘 공시 있어?",
"NAVER 이번주 공시 내용 정리해줘",
"카카오 최근 한 달 공시 현황",
"LG화학 공시 요약해서 보여줘",
"삼성전자 실적발표 공시 찾아줘",
"현대차 유상증자 관련 공시 있나?",
"SK텔레콤 배당 공시 확인해줘",
"포스코 합병 관련 공시 알려줘",
"셀트리온 임상시험 결과 공시 찾아봐",
"네이버 실적공시 분석해줘",
"삼성바이오 공시 내용이 주가에 미칠 영향은?",
"LG에너지솔루션 공시의 핵심 포인트는?",
"현대모비스 최근 공시 중요도 평가해줘",
"SK이노베이션 공시 트렌드 분석",
"반도체 관련 기업들 최근 공시 현황",
"바이오 업종 임상 관련 공시들 정리해줘",
"자동차 업종 공급망 관련 공시 찾아봐",
"금융업 실적 공시 모아서 보여줘",
"IT 업종 M&A 관련 공시들",
"배당 키워드 포함된 최근 공시들",
"유상증자 공시만 따로 모아줘",
"대규모 투자 관련 공시 찾아봐",
"신약 승인 관련 공시 검색해줘",
"ESG 관련 공시들 정리해줘",
"삼성전자 새로운 공시 나오면 알려줘",
"반도체 관련 공시 모니터링해줘",
"중요 공시 알림 설정하고 싶어",
"실적발표 일정 공시들 추적해줘",
"임상결과 공시 자동 스캔해줘",
"삼성전자와 SK하이닉스 공시 비교",
"현대차그룹 계열사 전체 공시 현황",
"코스피 200 기업 중 오늘 공시 현황",
"시가총액 상위 10개 기업 최근 공시",
"외국인 지분변동 공시들 모아서 보여줘",

]


test_set2 = ["- 루머 체크 관련 질문",
"* 삼성전자 애플 납품 중단설 사실이야?",
"* 테슬라 기가팩토리 한국 진출 루머 진짜야?",
"* SK하이닉스 중국 공장 철수설 확인해줘",
"* 네이버 카카오 합병설 사실 확인",
"* 현대차 애플카 협력설 진위 여부",
"* 삼성바이오 해외 제약회사 인수설 사실이야?",
"* LG에너지 중국 업체 인수 루머 확인",
"* 카카오뱅크 NH농협 합병설 진짜?",
"* 포스코 일본 철강사 인수설 진위",
"* CJ대한통운 해외 물류업체 인수 루머",
"* 삼성전자 3나노 양산 지연설 사실이야?",
"* LG디스플레이 애플 폴더블 공급설 확인",
"* SK텔레콤 6G 기술 독점 개발설 진짜?",
"* 현대차 수소차 대량생산 중단설 진위",
"* 네이버 메타버스 사업 포기설 확인해줘",
"* 삼성전자 CEO 교체설 사실 확인",
"* 네이버 창업자 복귀설 진짜야?",
"* 현대차 노조 파업설 진위 여부",
"* 카카오 대표 사임설 확인해줘",
"* LG화학 임원진 대폭 교체설 사실?",
"* 삼성전자 4분기 적자 전환설 진짜?",
"* SK하이닉스 메모리 가격 폭락 예상설",
"* 네이버 광고수익 급감설 사실 확인",
"* 현대차 중국 매출 반토막설 진위",
"* 카카오 금융 부문 분할설 확인",
"* 반도체법 개정으로 삼성 타격설 진짜?",
"* 플랫폼 규제로 네이버 제재설 확인",
"* 전기차 보조금 중단으로 현대차 타격설",
"* 게임 규제 강화로 넥슨 매출 급감설",
"* 배달 수수료 상한제로 배민 타격설",
"* 미중 무역분쟁으로 삼성 수혜설 진짜?",
"* 일본 수출규제 재개설 사실 확인",
"* 중국 한류 금한령 재개설 진위",
"* 미국 반도체 제재 강화설 확인",
"* 러시아 원료 공급 중단으로 포스코 타격설",

]


test_set3 = ["- 주가 검색 관련 질문",
"삼전 현재 주가 알려줘",
"SK하이닉스 오늘 주가 어때?",
"네이버 주가 얼마야?",
"카카오 현재가 확인해줘",
"현대차 주가 봐줘",
"삼성전자 주가 어제 대비 얼마나 올랐어?",
"LG화학 이번주 주가 변동률 알려줘",
"SK텔레콤 한 달 주가 추이 보여줘",
"포스코 작년 대비 주가 수익률은?",
"셀트리온 최근 3개월 주가 그래프",
"삼성전자와 SK하이닉스 주가 비교",
"네이버 vs 카카오 주가 수익률 비교",
"현대차 vs 기아 주가 성과 비교",
"바이오 3대장 주가 비교 분석",
"은행주들 주가 수익률 순위",
"삼성전자 주가 차트 패턴 분석해줘",
"SK하이닉스 이동평균선 분석",
"네이버 RSI 지표 확인해줘",
"현대차 볼린저밴드 상태는?",
"카카오 거래량 패턴 분석",
"오늘 코스피 지수 어때?",
"코스닥 상승률 상위 종목들",
"시가총액 순위 top 10",
"외국인 매수 상위 종목들",
"기관 순매수 종목 순위",
"반도체주들 오늘 주가 현황",
"바이오주 전체적으로 어때?",
"자동차주 섹터 분석해줘",
"배터리주 주가 동향은?",
"게임주 최근 흐름 알려줘",]



test_set4= ["-은어 관련 질문",
"하닉스 실적 어떻게 나올까?",
"셀바 임상 결과 언제 나와?",
"엘지화 배터리 관련 루머 진짜야?",
"카뱅 IPO 관련 공시 확인해줘",
"포홀딩스 분할 루머 사실이야?",
"현차 중국 진출설 확인해줘",
"네이바 메타버스 포기설 진위는?",
"테크윈 매각설 진짜야?",
"케이티 5G 관련 공시 있나?",
"삼성전자 물타기 타이밍이야?",
"SK하이닉스 존버할만해?",
"카카오 떡상 재료 뭐야?",
"셀트리온 개미털기 시작된거야?",
"네이버 손절 타이밍이야?",
"현대차 불타기 해도 될까?",
"LG화학 갈아타기 고민중이야",
"포스코 고점에서 물렸는데 어떡해?",
"SK텔레콤 바닥인 것 같은데 맞아?",
"삼성바이오 로켓 탈 준비됐나?",
"삼전 지금 개떡락인데 뭔 일이야?",
"하닉스 수직상승 시작됐나?",
"셀트리온 박스권 언제 벗어날까?",
"카카오 하락장에서 홀딩해도 될까?",
"네이버 횡보구간 언제까지야?",
"현대차 V자 반등 올까?",
"LG에솔 추가하락 있을까?",
"포스코 바운스 나올 타이밍이야?",
"SK이노 단타 치기 좋은 구간이야?",
"오늘 증시 개장 빨간불바다네",
"코스닥 완전 쪽박났네",
"외국인들 매도폭탄 던지는거야?",
"개인들 물량 던지기 시작했나?",
"기관 물량 받아주고 있어?",
"프로그램 매매 때문에 등락 심한거야?",
"장마감 전 뒤집기 있을까?",
"선물 만기일 영향 받는거야?",
"공매도 때문에 안 오르는거야?",
"테마주들 다 꺼졌네?",
"반도체 3인방 언제 살아날까?",
"바이오 대장주들 다 죽었네",
"2차전지 테마 완전 꺼졌어",
"메타버스주들 언제까지 바닥이야?",
"게임주 규제 때문에 못 살겠어",
"조선주 호황기 끝난거야?",
"화학주 실적 개판이네",
"카공 대장들 어떻게 보여?",
"인터넷은행주 다 똑같아 보여",
"ESG 테마주 아직 살아있나?",
"삼전 PER 개높은데 오를 수 있어?",
"하닉스 PBR 1 밑으로 떨어진 이유?",
"셀트리온 ROE 떨어지는거 문제야?",
"카카오 EPS 컨센서스 어떻게 되지?",
"네이버 BPS 대비 현재가 어때?",
"현대차 PSR 적정한 수준이야?",
"LG화학 EBITDA 마진 개판이네",
"포스코 배당수익률 괜찮은 편이야?",
"SK텔레콤 FCF 상황 어떤지 알아?",
"삼성바이오 밸류에이션 개높지 않아?",]

import time

for idx, dataset in enumerate([test_set, test_set2, test_set3, test_set4]):
    results = []
    for q in dataset:
        while True:
            try:
                result = llm.invoke(
                    question_classifier_template.format(query=q)
                )
                results.append((result.content, q))
                print(q, result.content)
                break  # 성공하면 루프 탈출
            except Exception as e:
                # 문자열에 '429' 포함되어 있으면 Rate Limit 에러로 간주
                if "429" in str(e):
                    print("Rate limit hit. Waiting 80 seconds...")
                    time.sleep(80)
                else:
                    # 다른 에러면 그냥 raise
                    raise e

    with open(f"multi_agent_results_{idx}.txt", "w") as f:
        for r in results:
            f.write(str(r) + "\n")

